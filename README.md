# Накопительная система лояльности «Гофермарт»

![Go Version](https://img.shields.io/badge/Go-1.24-blue)
![License](https://img.shields.io/badge/license-MIT-green)

Накопительная система лояльности «Гофермарт» — это современное HTTP API для управления программой лояльности интернет-магазина «Гофермарт». Проект позволяет пользователям регистрироваться, авторизовываться, загружать номера заказов и получать начисления на свой виртуальный счёт лояльности. Система также поддерживает вывод средств со счета и интегрируется с внешним сервисом расчёта баллов лояльности (работа которого представлена как «черный ящик»).

---

## Содержание

- [Обзор проекта](#обзор-проекта)
- [Особенности](#особенности)
- [Архитектура и бизнес-логика](#архитектура-и-бизнес-логика)
- [Используемые технологии](#используемые-технологии)
- [Установка и запуск](#установка-и-запуск)
- [Конфигурация](#конфигурация)
- [HTTP API](#http-api)
- [Тестирование](#тестирование)
- [Структура проекта](#структура-проекта)
- [Вклад и лицензия](#вклад-и-лицензия)

---

## Обзор проекта

Проект реализует систему лояльности, которая включает в себя:
- **Регистрацию** пользователей по логину и паролю с автоматической аутентификацией.
- **Аутентификацию** с использованием JWT и cookies.
- **Загрузку номеров заказов** от аутентифицированных пользователей. Номера проверяются по алгоритму Луна.
- **Учёт заказов**: хранение загруженных номеров, их статусов и информации о начисленных баллах.
- **Учёт накопительного счёта**: поддержка баланса лояльности, с возможностью начисления и списания баллов.
- **Интеграцию с внешним сервисом расчёта баллов лояльности** – сервис предоставляет информацию о количестве начисляемых баллов, без раскрытия внутренней логики расчёта.

---

## Особенности

- **Модульная архитектура:** код разделён на пакеты для API, бизнес-логики, работы с базой данных, конфигурации, логирования, шифрования, JWT и компрессии (gzip).
- **Безопасность:** пароли хранятся в виде bcrypt-хэшей, используется JWT для аутентификации, а cookies настроены с флагами Secure, HttpOnly и SameSite.
- **Конкурентность:** HTTP-сервер Go обрабатывает запросы параллельно с использованием встроенных горутин, а дополнительная параллелизация реализована там, где это необходимо.
- **Тестируемость:** покрытие тестами с использованием библиотеки [testify](https://github.com/stretchr/testify) и [sqlmock](https://github.com/DATA-DOG/go-sqlmock) для эмуляции работы с базой данных.

---

## Архитектура и бизнес-логика

### Бизнес-процесс

1. **Регистрация:** пользователь регистрируется в системе, указывая уникальный логин и пароль.
2. **Покупка:** пользователь совершает покупку в интернет-магазине «Гофермарт» (это гипотетический шаг, не реализованный в системе).
3. **Передача заказа:** пользователь отправляет номер заказа в систему лояльности.
4. **Расчёт баллов:** система обращается к внешнему сервису расчёта баллов (черный ящик) для проверки и получения информации о начисляемых баллах.
5. **Начисление баллов:** при положительном расчёте баллов система зачисляет вознаграждение на накопительный счёт пользователя.
6. **Использование баллов:** пользователь может использовать баллы для оплаты последующих заказов, списывая их с накопительного счёта.

### Взаимодействие с внешним сервисом

Сервис расчёта баллов лояльности работает как внешнее API (черный ящик), предоставляя информацию о начислении баллов за конкретный заказ. Процесс интеграции реализован через отдельный HTTP-хендлер, который позволяет получать статус и сумму начислений для переданного номера заказа.

---

## Используемые технологии

- **Язык программирования:** Go (Golang) 1.24
- **Веб-фреймворк:** [chi](https://github.com/go-chi/chi) — легковесный роутер для HTTP API
- **Работа с БД:** [sqlx](https://github.com/jmoiron/sqlx) для удобной работы с PostgreSQL (используется драйвер pgx)
- **База данных:** PostgreSQL (хранение пользователей, заказов, транзакций по баллам и истории выводов)
- **JWT:** [golang-jwt](https://github.com/golang-jwt/jwt) для аутентификации и авторизации
- **Шифрование:** [bcrypt](https://pkg.go.dev/golang.org/x/crypto/bcrypt) для хеширования паролей
- **Логирование:** [zap](https://github.com/uber-go/zap) для структурированного логирования
- **Сжатие:** встроенная поддержка gzip для сжатия HTTP-ответов/запросов
- **Тестирование:** [testify](https://github.com/stretchr/testify) и [sqlmock](https://github.com/DATA-DOG/go-sqlmock)

---

## Установка и запуск

### Локальная разработка

1. **Клонирование репозитория:**

   ```bash
   git clone https://github.com/your_username/gophermart.git
   cd gophermart
   ```

2. **Настройка переменных окружения:**

   Создайте файл `.env` в корне проекта и заполните его примерно так:

   ```dotenv
   RUN_ADDRESS=:8080
   POSTGRES_USER=postgres
   POSTGRES_PASSWORD=postgres
   POSTGRES_DB=gophermart
   HOST=db
   SECRET_KEY=ваш_секретный_ключ

   DATABASE_URI=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@${HOST}:5432/${POSTGRES_DB}
   ```

3. **Запуск проекта с помощью Docker:**

   Проект поставляется с Docker Compose конфигурацией. Для сборки и запуска выполните:

   ```bash
   docker-compose up --build
   ```

   Это запустит приложение и PostgreSQL в контейнерах.

4. **Локальный запуск без Docker:**

   Если вы предпочитаете запуск без Docker, убедитесь, что у вас установлен PostgreSQL, затем:

   ```bash
   go mod download
   go run ./cmd/main.go
   ```

   Приложение запустится на адресе, указанном в переменной `RUN_ADDRESS` (по умолчанию `:8080`).

---

## Конфигурация

Конфигурация проекта определяется через переменные окружения или флаги:
- **RUN_ADDRESS** — адрес и порт для HTTP-сервера.
- **DATABASE_URI** — строка подключения к базе данных PostgreSQL.
- **SECRET_KEY** — секретный ключ для генерации JWT.
- **ACCUAL_SYSTEM_ADDRESS** — адрес внешней системы расчёта баллов (если потребуется).

Файл конфигурации находится в пакете `pkg/config/config.go`, где происходит приоритетное чтение флагов командной строки и переменных окружения.

---

## HTTP API

### Регистрация пользователя

- **Метод:** `POST`
- **Путь:** `/api/user/register`
- **Тело запроса (JSON):**
  ```json
  {
      "login": "<login>",
      "password": "<password>"
  }
  ```
- **Коды ответа:**
    - `200` — успешная регистрация и аутентификация.
    - `400` — неверный формат запроса.
    - `409` — логин уже занят.
    - `500` — внутренняя ошибка сервера.

### Аутентификация пользователя

- **Метод:** `POST`
- **Путь:** `/api/user/login`
- **Тело запроса (JSON):**
  ```json
  {
      "login": "<login>",
      "password": "<password>"
  }
  ```
- **Коды ответа:**
    - `200` — успешная аутентификация.
    - `400` — неверный формат запроса.
    - `401` — неверная пара логин/пароль.
    - `500` — внутренняя ошибка сервера.

### Загрузка номера заказа

- **Метод:** `POST`
- **Путь:** `/api/user/orders`
- **Тело запроса:** текстовый (номер заказа)
- **Проверка:** алгоритм Луна для валидации номера заказа.
- **Коды ответа:**
    - `200` — заказ уже был загружен данным пользователем.
    - `202` — заказ принят в обработку.
    - `400` — неверный формат запроса.
    - `401` — пользователь не аутентифицирован.
    - `409` — заказ загружен другим пользователем.
    - `422` — неверный формат номера заказа.
    - `500` — внутренняя ошибка сервера.

### Получение списка заказов

- **Метод:** `GET`
- **Путь:** `/api/user/orders`
- **Коды ответа:**
    - `200` — список заказов в формате JSON (с сортировкой по времени загрузки).
    - `204` — нет данных.
    - `401` — пользователь не авторизован.
    - `500` — внутренняя ошибка сервера.

### Получение баланса лояльности

- **Метод:** `GET`
- **Путь:** `/api/user/balance`
- **Формат ответа (JSON):**
  ```json
  {
      "current": 500.5,
      "withdrawn": 42
  }
  ```
- **Коды ответа:**
    - `200` — успешное получение данных.
    - `401` — пользователь не авторизован.
    - `500` — внутренняя ошибка сервера.

### Запрос на списание баллов

- **Метод:** `POST`
- **Путь:** `/api/user/balance/withdraw`
- **Тело запроса (JSON):**
  ```json
  {
      "order": "<номер заказа>",
      "sum": <сумма списания>
  }
  ```
- **Коды ответа:**
    - `200` — успешно обработан запрос.
    - `401` — пользователь не авторизован.
    - `402` — недостаточно средств.
    - `422` — неверный номер заказа.
    - `500` — внутренняя ошибка сервера.

### Получение информации о выводе средств

- **Метод:** `GET`
- **Путь:** `/api/user/withdrawals`
- **Коды ответа:**
    - `200` — список транзакций в формате JSON.
    - `204` — нет данных.
    - `401` — пользователь не авторизован.
    - `500` — внутренняя ошибка сервера.

### Информация о расчёте начислений баллов (внешний сервис)

- **Метод:** `GET`
- **Путь:** `/api/orders/{number}`
- **Коды ответа:**
    - `200` — успешное получение данных о расчёте.
    - `204` — заказ не зарегистрирован в системе расчёта.
    - `429` — превышено количество запросов.
    - `500` — внутренняя ошибка сервера.

---

## Тестирование

Для тестирования проекта используются:
- **testify** — для написания и выполнения unit-тестов.
- **sqlmock** — для эмуляции работы с базой данных.
- **go test** — стандартная утилита для запуска тестов.

### Запуск тестов

Для запуска всех тестов выполните:

```bash
go test ./...
```

Или, если вы используете Docker, можно добавить соответствующую команду в Dockerfile или docker-compose.

---

## Структура проекта

```
gophermart/
├── cmd/
│   └── main.go              # Точка входа приложения
├── internal/
│   ├── api/                 # HTTP-обработчики (регистрация, логин, заказы, баланс и т.д.)
│   ├── middleware/          # Middleware для проверки cookies и авторизации
│   └── service/
│       ├── luhn/            # Реализация алгоритма Луна
│       └── user/            # Логика работы с пользователями (установка JWT)
├── pkg/
│   ├── config/              # Конфигурация приложения
│   ├── database/            # Работа с PostgreSQL (подключение, запросы, миграции)
│   ├── gzip/                # Middleware для работы со сжатием gzip
│   ├── hash/                # Функции хеширования паролей (bcrypt)
│   ├── jwt/                 # Генерация и проверка JWT
│   ├── logger/              # Инициализация логгера (zap)
│   ├── mErrors/             # Определение пользовательских ошибок
│   └── models/              # Модели данных (User, Order, LoyaltyAccount, Withdrawal)
├── pkg/database/migrations/ # SQL миграции для создания таблиц
├── .env                     # Конфигурация окружения (не включается в git)
├── docker-compose.yml       # Docker Compose конфигурация для запуска сервиса и БД
├── Dockerfile               # Dockerfile для сборки приложения
└── README.md                # Этот файл
```

---

## Вклад и лицензия

Если вы хотите внести свой вклад в развитие проекта, пожалуйста, создавайте pull-request или открывайте issue для обсуждения новых идей.  
Проект распространяется по лицензии [MIT License](LICENSE).

---

## Заключение

Накопительная система лояльности «Гофермарт» разработана с использованием лучших практик Go-разработки, уделяя внимание безопасности, тестируемости и масштабируемости. Надеемся, что этот проект станет хорошей основой для дальнейшего развития бизнес-логики в рамках программы лояльности, а также послужит отличным примером реализации современных микросервисов на Go.

---